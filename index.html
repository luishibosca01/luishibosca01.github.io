<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; script-src 'self' 'unsafe-inline'; style-src 'self' 'unsafe-inline';">
    <title>Horarios</title>
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icons/icon-192.png">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f9fafb;
            overflow-anchor: none;
        }

        /* --- ESTILOS DE ICONOS SVG --- */
        .icon {
            width: 1.2em;
            height: 1.2em;
            vertical-align: text-bottom;
            fill: currentColor;
            stroke: currentColor;
            stroke-width: 0;
        }

        .icon-line {
            stroke-width: 2;
            fill: none;
        }

        .header {
            background: white;
            padding: 0.3rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            position: sticky;
            top: 0;
            z-index: 10;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header h1 {
            font-size: 1.25rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }

        .card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .card h2 {
            font-size: 1rem;
            margin-bottom: 1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-size: 0.875rem;
            font-weight: 600;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 1rem;
        }

        input:focus {
            outline: none;
            border-color: #272450;
        }

        input.error {
            border-color: #c05d76;
        }

        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        input[type="number"] {
            -moz-appearance: textfield;
            appearance: textfield;
        }

        .input-error {
            color: #c05d76;
            font-size: 0.75rem;
            margin-top: 0.25rem;
            display: none;
        }

        button {
            width: 100%;
            padding: 0.875rem;
            background: #4b5563;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        button:hover {
            transform: scale(1.02);
        }

        button:active {
            transform: translateY(0);
        }

        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
            transform: none;
        }

        .stats-card {
            background: #fefeff;
            color: rgb(0, 0, 0);
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stats-card:hover {
            transform: scale(1.02);
        }

        .stats-card:active {
            transform: translateX(2px);
        }

        .stats-card h2 {
            color: rgb(0, 0, 0);
        }

        body.dark-mode .stats-card h2 {
            color: white;
        }


        .stats-number {
            font-size: 1.8rem;
            font-weight: bold;
            margin: 0.5rem 0;
        }

        .progress-bar {
            width: 100%;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .progress-fill {
            height: 100%;
            background: white;
            border-radius: 12px;
            transition: width 0.5s;
        }

        .progress-fill.blue {
            background: #5382e6 !important;
        }

        .progress-fill.green {
            background: #60ac94 !important;
        }

        .progress-fill.red {
            background: #c05d76 !important;
        }

        .registro-item {
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: start;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .registro-item:hover {
            transform: scale(1.02);
        }

        .registro-item:active {
            transform: translateX(2px);
        }

        .registro-info {
            flex: 1;
        }

        .registro-fecha {
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.25rem;
        }

        .registro-horas {
            font-size: 0.875rem;
            color: #6b7280;
        }

        .registro-total {
            font-size: 0.875rem;
            font-weight: 600;
            color: #d6af66;
            margin-top: 0.25rem;
        }

        .registro-total.green-text {
            color: #60ac94;
        }

        .registro-total.red-text {
            color: #c05d76;
        }

        .btn-small {
            width: auto;
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-delete {
            background: #c04d6a;
        }

        .btn-delete:hover {
            transform: scale(1.02);
        }

        .btn-export {
            background: #50917d;
        }

        .btn-export:hover {
            transform: scale(1.02);
        }

        .btn-backup {
            background: #5382e6;
        }

        .btn-backup:hover {
            transform: scale(1.02);
        }

        .empty-state {
            text-align: center;
            padding: 3rem 1rem;
            color: #9ca3af;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .icon-btn {
            width: auto;
            padding: 0.5rem;
            font-size: 1.25rem;
            min-width: 44px;
            background: transparent;
            color: #334155;
            border: 1px solid #e2e8f0;
        }

        .icon-btn:hover {
            transform: scale(1.02);
        }

        .registro-item.hoy {
            border-left: 5px solid #374151;
        }

        body.dark-mode .registro-item.hoy {
            border-left-color: #ffffff;
        }

        body.dark-mode {
            background: #111827;
            color: #f9fafb;
        }

        body.dark-mode .header {
            background: #1f2937;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        body.dark-mode .header h1 {
            color: #f9fafb;
        }

        body.dark-mode .card {
            background: #1f2937;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
            color: white;
        }

        body.dark-mode .card h2 {
            color: #f9fafb;
        }

        body.dark-mode label {
            color: #d1d5db;
        }

        body.dark-mode input {
            background: #374151;
            border-color: #4b5563;
            color: #f9fafb;
        }

        body.dark-mode .registro-item {
            border-color: #4b5563;
            background: #374151;
        }

        body.dark-mode .registro-fecha {
            color: #f9fafb;
        }

        body.dark-mode .registro-horas {
            color: #d1d5db;
        }

        body.dark-mode .modal-content {
            background: #1f2937;
        }

        body.dark-mode .modal h3 {
            color: #f9fafb;
        }

        body.dark-mode .icon-btn {
            color: #f1f5f9;
            border-color: #4b5563;
        }

        .time-btn {
            width: 50px;
            height: 50px;
            padding: 0.5rem;
            font-size: 1.25rem;
            background: #cbd5e1;
            color: #0f172a;
        }

        .time-btn:hover {
            transform: scale(1.02);
        }

        body.dark-mode .time-btn {
            background: #4b5563;
            color: white;
        }

        .input-with-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-with-btn input {
            flex: 1;
        }

        .input-number-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .input-number-group input {
            flex: 1;
            text-align: center;
        }

        .btn-increment {
            width: 50px;
            height: 50px;
            padding: 0.25rem;
            font-size: 1.25rem;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #cbd5e1;
        }

        .btn-increment:hover {
            transform: scale(1.02);
        }

        .btn-increment:active {
            transform: scale(0.95);
        }

        body.dark-mode .btn-increment {
            background: #4b5563;
        }

        body.dark-mode .btn-increment:hover {
            transform: scale(1.02);
        }

        .modal {
            display: flex;
            visibility: hidden;
            opacity: 0;
            pointer-events: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 100;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            backdrop-filter: blur(1px);
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }

        .modal.show {
            visibility: visible;
            opacity: 1;
            pointer-events: auto;
        }

        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 1rem;
            max-width: 450px;
            width: 100%;
        }

        .modal h3 {
            margin-bottom: 1rem;
            color: #1f2937;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .btn-group {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-cancel {
            background: #64748b;
        }

        .btn-cancel:hover {
            transform: scale(1.02);
        }

        .btn-edit {
            background: #5382e6;
        }

        .btn-edit:hover {
            transform: scale(1.02);
        }


        .actions-row {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .actions-row .btn-small {
            flex: 1;
            min-width: auto;
        }

        .toast {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: #1f2937;
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateY(100px);
            transition: all 0.3s ease;
            z-index: 1000;
            max-width: 300px;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .toast.show {
            opacity: 1;
            transform: translateY(0);
            animation: toastSlide 0.3s ease;
        }

        @keyframes toastSlide {
            0% {
                transform: translateY(100px) scale(0.8);
                opacity: 0;
            }

            100% {
                transform: translateY(0) scale(1);
                opacity: 1;
            }
        }

        @keyframes zoomIn {
            from {
                opacity: 0;
                transform: scale(0.8);
                /* Empieza al 80% del tama√±o */
            }

            to {
                opacity: 1;
                transform: scale(1);
                /* Termina al 100% del tama√±o */
            }
        }

        .animated-card {
            animation: zoomIn 0.5s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
            /* Usamos una curva m√°s din√°mica */
        }

        .toast.success {
            background: #60ac94;
        }

        .toast.error {
            background: #c05d76;
        }

        .toast.warning {
            background: #c05d76;
        }

        .toast.info {
            background: #5382e6;
        }

        .toast::before {
            content: '';
            font-size: 1.5rem;
        }

        .toast.success::before {
            content: '‚úì';
        }

        .toast.error::before {
            content: '‚úï';
        }

        .toast.warning::before {
            content: '‚ö†';
        }

        .toast.info::before {
            content: '‚Ñπ';
        }

        .toggle-hint {
            display: block;
            margin-top: 0.5rem;
            font-size: 0.75rem;
            font-weight: 400;
            color: rgba(0, 0, 0, 0.7);
            text-align: right;
        }

        body.dark-mode .toggle-hint {
            color: rgba(255, 255, 255, 0.7);
        }

        .registro-grupo-titulo {
            font-size: 1.1rem;
            margin: 1.5rem 0 0.5rem;
            color: #586fa1;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
            font-weight: 700;
        }

        body.dark-mode .registro-grupo-titulo {
            color: #7a9be2;
            border-bottom-color: #374151;
        }

        .config-hint-text {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
            text-align: right;
        }

        body.dark-mode .config-hint-text {
            color: #9ca3af;
        }

        .config-actions {
            margin-top: 2rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            align-items: stretch;
        }

        .export-import-stack {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .export-import-stack button {
            flex: 1;
            width: 100%;
        }

        .large-btn-config {
            grid-row-start: 1;
            grid-row-end: span 2;
            align-self: stretch;
            height: 100%;
        }

        .modal-title-block {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .version-text {
            font-size: 0.8rem;
            color: #9ca3af;
            font-weight: 400;
        }

        body.dark-mode .version-text {
            color: #6b7280;
        }

        .time-btn:disabled {
            background: transparent;
            color: #6b7280;
            opacity: 1;
        }

        body.dark-mode .time-btn:disabled {
            background: transparent;
            color: #6b7280;
            transform: none;
        }
    </style>
</head>

<body>
    <script>
        (function () {
            try {
                var stored = localStorage.getItem('temaOscuro');
                if (stored === 'true' || stored === null) {
                    document.body.classList.add('dark-mode');
                }
            } catch (e) { }
        })();
    </script>
    <svg style="display: none;">
        <symbol id="icon-moon" viewBox="0 0 24 24">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z" class="icon-line" stroke-width="2"
                stroke="currentColor" fill="none"></path>
        </symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24">
            <g class="icon-line" stroke-width="2" stroke="currentColor">
                <circle cx="12" cy="12" r="5"></circle>
                <line x1="12" y1="1" x2="12" y2="3"></line>
                <line x1="12" y1="21" x2="12" y2="23"></line>
                <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                <line x1="1" y1="12" x2="3" y2="12"></line>
                <line x1="21" y1="12" x2="23" y2="12"></line>
                <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
            </g>
        </symbol>
        <symbol id="icon-settings" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="3" class="icon-line" stroke="currentColor"></circle>
            <path
                d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"
                class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-clock" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" class="icon-line" stroke="currentColor"></circle>
            <polyline points="12 6 12 12 16 14" class="icon-line" stroke="currentColor"></polyline>
        </symbol>
        <symbol id="icon-trash" viewBox="0 0 24 24">
            <polyline points="3 6 5 6 21 6" class="icon-line" stroke="currentColor"></polyline>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2" class="icon-line"
                stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-save" viewBox="0 0 24 24">
            <path d="M19 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11l5 5v11a2 2 0 0 1-2 2z" class="icon-line"
                stroke="currentColor"></path>
            <polyline points="17 21 17 13 7 13 7 21" class="icon-line" stroke="currentColor"></polyline>
            <polyline points="7 3 7 8 15 8" class="icon-line" stroke="currentColor"></polyline>
        </symbol>
        <symbol id="icon-broom" viewBox="0 0 24 24">
            <path class="icon-line"
                d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM8 11v6M12 11v6M16 11v6M10 3L9 6h6l-1-3" />
        </symbol>
        <symbol id="icon-download" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" class="icon-line" stroke="currentColor"></path>
            <polyline points="7 10 12 15 17 10" class="icon-line" stroke="currentColor"></polyline>
            <line x1="12" y1="15" x2="12" y2="3" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-upload" viewBox="0 0 24 24">
            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4" class="icon-line" stroke="currentColor"></path>
            <polyline points="17 8 12 3 7 8" class="icon-line" stroke="currentColor"></polyline>
            <line x1="12" y1="3" x2="12" y2="15" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-edit" viewBox="0 0 24 24">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7" class="icon-line"
                stroke="currentColor"></path>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z" class="icon-line" stroke="currentColor">
            </path>
        </symbol>
        <symbol id="icon-calendar" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <line x1="16" y1="2" x2="16" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="2" x2="8" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="10" x2="21" y2="10" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-list" viewBox="0 0 24 24">
            <line x1="8" y1="6" x2="21" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="12" x2="21" y2="12" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="18" x2="21" y2="18" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="6" x2="3.01" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="12" x2="3.01" y2="12" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="18" x2="3.01" y2="18" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-cancelar" viewBox="0 0 24 24">
            <line x1="18" y1="6" x2="6" y2="18" class="icon-line" stroke="currentColor"></line>
            <line x1="6" y1="6" x2="18" y2="18" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-undo" viewBox="0 0 24 24">
            <path d="M3 7v6h6" class="icon-line" stroke="currentColor"></path>
            <path d="M21 17a9 9 0 00-9-9 9 9 0 00-6 2.3L3 13" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-redo" viewBox="0 0 24 24">
            <path d="M21 7v6h-6" class="icon-line" stroke="currentColor"></path>
            <path d="M3 17a9 9 0 019-9 9 9 0 016 2.3L21 13" class="icon-line" stroke="currentColor"></path>
        </symbol>
        <symbol id="icon-clock-simple" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" class="icon-line" stroke="currentColor"></circle>
            <polyline points="12 6 12 12 16 14" class="icon-line" stroke="currentColor"></polyline>
        </symbol>
        <symbol id="icon-calendar-simple" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <line x1="16" y1="2" x2="16" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="2" x2="8" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="10" x2="21" y2="10" class="icon-line" stroke="currentColor"></line>
        </symbol>
        <symbol id="icon-timer" viewBox="0 0 24 24">
            <line x1="10" y1="2" x2="14" y2="2" class="icon-line" stroke="currentColor"></line>
            <line x1="12" y1="14" x2="15" y2="11" class="icon-line" stroke="currentColor"></line>
            <circle cx="12" cy="14" r="8" class="icon-line" stroke="currentColor"></circle>
        </symbol>
        <symbol id="icon-calendar-check" viewBox="0 0 24 24">
            <rect x="3" y="4" width="18" height="18" rx="2" ry="2" class="icon-line" stroke="currentColor"></rect>
            <line x1="16" y1="2" x2="16" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="8" y1="2" x2="8" y2="6" class="icon-line" stroke="currentColor"></line>
            <line x1="3" y1="10" x2="21" y2="10" class="icon-line" stroke="currentColor"></line>
            <path d="M9 16l2 2 4-4" class="icon-line" stroke="currentColor"></path>
        </symbol>
    </svg>

    <div class="header">
        <h1><svg class="icon">
                <use href="#icon-clock" />
            </svg> Horarios</h1>
        <div class="header-buttons">
            <button class="icon-btn" id="theme-toggle" onclick="UILogic.alternarTema()">
                <svg class="icon">
                    <use href="#icon-moon" />
                </svg>
            </button>
            <button class="icon-btn" onclick="UILogic.mostrarConfig()">
                <svg class="icon">
                    <use href="#icon-settings" />
                </svg>
            </button>
        </div>
    </div>

    <div id="toast" class="toast"></div>

    <div class="container">

        <div class="card stats-card animated-card" id="stats-card" onclick="UILogic.alternarVista()"
            style="animation-delay: 0s;">
            <h2 id="stats-titulo">üìÖ Hoy</h2>
            <div class="stats-number" id="stats-semana">
                <div>0 horas 0 minutos</div>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progress-bar" style="width: 0%"></div>
            </div>
            <div id="stats-mensaje">Faltan 0 horas 0 minutos</div>
            <div id="stats-buffer" style="font-size: 0.85rem; margin-top: 0.5rem; min-height: 1.2rem;"></div>
            <span class="toggle-hint" id="toggle-hint">Toca para ver la Semana</span>
        </div>

        <div class="card animated-card" style="animation-delay: 0.1s;">
            <h2><svg class="icon">
                    <use href="#icon-edit" />
                </svg> Registrar Horas</h2>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="fecha" />
                <span class="input-error" id="error-fecha">Fecha inv√°lida</span>
            </div>
            <div class="form-group">
                <label>Hora de Entrada</label>
                <div class="input-with-btn">
                    <input type="text" id="entrada" placeholder="00:00 para Feriado" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.pegarHoraActual('entrada')"><svg class="icon">
                            <use href="#icon-clock" />
                        </svg></button>
                    <button class="time-btn" onclick="UILogic.limpiarCampo('entrada')"><svg class="icon">
                            <use href="#icon-broom" />
                        </svg></button>
                </div>
                <span class="input-error" id="error-entrada">Formato inv√°lido (HH:MM)</span>
            </div>
            <div class="form-group">
                <label>Hora de Salida</label>
                <div class="input-with-btn">
                    <input type="text" id="salida" placeholder="00:00 para Feriado" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.pegarHoraActual('salida')"><svg class="icon">
                            <use href="#icon-clock" />
                        </svg></button>
                    <button class="time-btn" onclick="UILogic.limpiarCampo('salida')"><svg class="icon">
                            <use href="#icon-broom" />
                        </svg></button>
                </div>
                <span class="input-error" id="error-salida">Formato inv√°lido (HH:MM)</span>
            </div>
            <button onclick="DataManagement.agregarRegistro()" id="btn-agregar"><svg class="icon">
                    <use href="#icon-save" />
                </svg> Registrar</button>
        </div>

        <div class="card animated-card" style="animation-delay: 0.2s;">
            <div
                style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; flex-wrap: wrap; gap: 0.5rem;">
                <h2 style="margin-bottom: 0;">
                    <svg class="icon">
                        <use href="#icon-list" />
                    </svg> Hist√≥rico
                </h2>
                <div style="display: flex; gap: 0.5rem;">
                    <button class="time-btn" id="btn-undo" onclick="HistoryManager.undo()" title="Deshacer">
                        <svg class="icon">
                            <use href="#icon-undo" />
                        </svg>
                    </button>
                    <button class="time-btn" id="btn-redo" onclick="HistoryManager.redo()" title="Rehacer">
                        <svg class="icon">
                            <use href="#icon-redo" />
                        </svg>
                    </button>
                </div>
            </div>
            <div id="lista-registros"></div>
            <button id="btn-cargar-mas" class="btn-small btn-backup" style="margin-top: 1rem; display: none;"
                onclick="DataManagement.cargarMasRegistros()"></button>
        </div>
    </div>

    <div class="modal" id="modal-config">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-settings" />
                    </svg>
                    Configuraci√≥n
                </span>
                <span class="version-text">v5.5</span> <!-- Version -->
            </h3>
            <div class="form-group">
                <label>Horas diarias</label>
                <div class="input-number-group">
                    <input type="number" id="config-horas-diarias" min="1" max="24" step="0.5" readonly />
                    <button class="btn-increment" onclick="UILogic.incrementarHorasDiarias()">+</button>
                    <button class="btn-increment" onclick="UILogic.decrementarHorasDiarias()">‚àí</button>
                </div>
            </div>
            <div class="form-group">
                <label>D√≠as h√°biles por semana</label>
                <div class="input-number-group">
                    <input type="number" id="config-dias-habiles" min="1" max="7" step="1" readonly />
                    <button class="btn-increment" onclick="UILogic.incrementarDiasHabiles()">+</button>
                    <button class="btn-increment" onclick="UILogic.decrementarDiasHabiles()">‚àí</button>
                </div>
                <div id="config-total-feedback" class="config-hint-text">(Total semanal: 35hs)</div>
            </div>
            <div class="config-actions">
                <div class="export-import-stack">
                    <button class="btn-export" onclick="DataManagement.exportarJSON()"><svg class="icon">
                            <use href="#icon-download" />
                        </svg> Exportar</button>
                    <button class="btn-backup" onclick="UILogic.mostrarImportar()"><svg class="icon">
                            <use href="#icon-upload" />
                        </svg> Importar</button>
                </div>
                <button class="btn-delete" onclick="DataManagement.borrarTodoHistorial()"><svg class="icon">
                        <use href="#icon-trash" />
                    </svg>Borrar registros</button>
            </div>
            <div class="btn-group">
                <button onclick="DataManagement.guardarConfig()"><svg class="icon">
                        <use href="#icon-save" />
                    </svg> Guardar</button>
                <button class="btn-cancel" onclick="UILogic.cerrarConfig()"><svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg> Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-editar">
        <div class="modal-content">
            <h3>
                <span class="modal-title-block">
                    <svg class="icon">
                        <use href="#icon-edit" />
                    </svg>Editar Registro
                </span>
            </h3>
            <div class="form-group">
                <label>Fecha</label>
                <input type="date" id="edit-fecha" />
            </div>
            <div class="form-group">
                <label>Entrada</label>
                <div class="input-with-btn">
                    <input type="text" id="edit-entrada" placeholder="HH:MM" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.pegarHoraActual('edit-entrada')"><svg class="icon">
                            <use href="#icon-clock" />
                        </svg></button>
                    <button class="time-btn" onclick="UILogic.limpiarCampo('edit-entrada')"><svg class="icon">
                            <use href="#icon-broom" />
                        </svg></button>
                </div>
            </div>
            <div class="form-group">
                <label>Salida</label>
                <div class="input-with-btn">
                    <input type="text" id="edit-salida" placeholder="HH:MM" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.pegarHoraActual('edit-salida')"><svg class="icon">
                            <use href="#icon-clock" />
                        </svg></button>
                    <button class="time-btn" onclick="UILogic.limpiarCampo('edit-salida')"><svg class="icon">
                            <use href="#icon-broom" />
                        </svg></button>
                </div>
            </div>
            <div class="form-group">
                <label>Tiempo Fuera (opcional)</label>
                <div class="input-with-btn">
                    <input type="text" id="edit-tiempo-fuera" placeholder="Ej: 00:20" maxlength="5" />
                    <button class="time-btn" onclick="UILogic.limpiarCampo('edit-tiempo-fuera')"><svg class="icon">
                            <use href="#icon-broom" />
                        </svg></button>
                </div>
            </div>
            <div class="btn-group">
                <button class="btn-edit" onclick="DataManagement.guardarEdicion()"><svg class="icon">
                        <use href="#icon-save" />
                    </svg> Guardar</button>
                <button class="btn-delete" onclick="DataManagement.eliminarRegistroActual()"><svg class="icon">
                        <use href="#icon-trash" />
                    </svg> Eliminar</button>
            </div>
            <div class="btn-group">
                <button class="btn-cancel" onclick="UILogic.cerrarEdicion()"><svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg> Cancelar</button>
            </div>
        </div>
    </div>

    <div class="modal" id="modal-importar">
        <div class="modal-content">
            <h3><svg class="icon">
                    <use href="#icon-upload" />
                </svg> Importar Datos</h3>
            <div class="form-group">
                <label>Selecciona archivo (.json)</label>
                <input type="file" id="file-import" accept=".json" />
                <div class="config-hint-text" style="text-align: left; margin-top: 0.5rem;">
                    Elige una opci√≥n:
                </div>
            </div>

            <div style="display: flex; flex-direction: column; gap: 0.75rem; margin-top: 1rem;">
                <button class="btn-backup" onclick="DataManagement.importarDatos('merge')">
                    <svg class="icon">
                        <use href="#icon-list" />
                    </svg>
                    Combinar (Agregar faltantes)
                </button>

                <button class="btn-delete" onclick="DataManagement.importarDatos('replace')">
                    <svg class="icon">
                        <use href="#icon-trash" />
                    </svg>
                    Reemplazar todo (Borrar actual)
                </button>

                <button class="btn-cancel" onclick="UILogic.cerrarImportar()">
                    <svg class="icon">
                        <use href="#icon-cancelar" />
                    </svg>
                    Cancelar
                </button>
            </div>
        </div>
    </div>

    <script>
        (function () {
            'use strict';

            const $ = id => document.getElementById(id);

            // ====================================================================
            // I. SECURITY AND UTILS MODULE
            // ====================================================================
            const SecurityAndUtils = (function () {
                const SECURITY_LIMITS = {
                    MAX_REGISTROS: 1000,
                    MAX_STRING_LENGTH: 100,
                    MAX_JSON_SIZE: 4 * 1024 * 1024,
                    SCHEMA_VERSION: 3,
                    MAX_OPERATIONS_PER_MINUTE: 30
                };

                const REGEX_PATTERNS = {
                    FECHA: /^\d{4}-(0[1-9]|1[0-2])-(0[1-9]|[12]\d|3[01])$/,
                    HORA: /^([01]\d|2[0-3]):([0-5]\d)$/,
                    ID: /^[a-zA-Z0-9-_]{10,100}$/
                };

                class RateLimiter {
                    constructor(maxOps, windowMs) {
                        this.maxOps = maxOps;
                        this.windowMs = windowMs;
                        this.operations = [];
                    }
                    canProceed() {
                        const now = Date.now();
                        this.operations = this.operations.filter(time => now - time < this.windowMs);
                        if (this.operations.length >= this.maxOps) return false;
                        this.operations.push(now);
                        return true;
                    }
                }

                const saveLimiter = new RateLimiter(SECURITY_LIMITS.MAX_OPERATIONS_PER_MINUTE, 60000);

                function sanitizeString(str, maxLength = SECURITY_LIMITS.MAX_STRING_LENGTH) {
                    if (typeof str !== 'string') return '';

                    // Remover m√°s caracteres peligrosos
                    return str
                        .replace(/[<>"'`]/g, '') // Comillas invertidas tambi√©n
                        .replace(/javascript:/gi, '') // Prevenir javascript: URLs
                        .replace(/on\w+\s*=/gi, '') // Prevenir event handlers (onclick=, onerror=)
                        .replace(/[\x00-\x1F\x7F]/g, '') // Remover caracteres de control
                        .trim()
                        .substring(0, maxLength);
                }

                function validarFechaSegura(f) {
                    if (!f || !REGEX_PATTERNS.FECHA.test(f)) return false;

                    try {
                        const [y, m, d] = f.split('-').map(Number);
                        const fecha = new Date(y, m - 1, d);
                        if (fecha.getFullYear() !== y ||
                            fecha.getMonth() !== m - 1 ||
                            fecha.getDate() !== d) {
                            return false;
                        }

                        const ahora = new Date();
                        const hace20Anos = new Date(ahora.getFullYear() - 20, 0, 1);
                        const en2Anos = new Date(ahora.getFullYear() + 2, 11, 31);

                        return fecha >= hace20Anos && fecha <= en2Anos && !isNaN(fecha.getTime());
                    } catch (e) {
                        return false;
                    }
                }

                function validarHoraSegura(h) {
                    return h && REGEX_PATTERNS.HORA.test(h);
                }

                function generarIDSeguro() {
                    if (window.crypto && window.crypto.getRandomValues) {
                        const array = new Uint32Array(4);
                        crypto.getRandomValues(array);
                        return Array.from(array, num => num.toString(36)).join('');
                    }
                    const timestamp = Date.now().toString(36);
                    const random1 = Math.random().toString(36).substring(2, 11);
                    const random2 = Math.random().toString(36).substring(2, 11);
                    return `${timestamp}-${random1}${random2}`;
                }

                function calcularHashFNV1a(data) {
                    const str = JSON.stringify(data);
                    let hash = 0x811c9dc5;
                    for (let i = 0; i < str.length; i++) {
                        hash ^= str.charCodeAt(i);
                        hash = Math.imul(hash, 0x01000193);
                    }
                    return (hash >>> 0).toString(16);
                }

                function validarRegistroSeguro(r) {
                    if (!r || typeof r !== 'object') return false;
                    if (Array.isArray(r) || r instanceof Date) return false;
                    if (typeof r.id !== 'string' || !REGEX_PATTERNS.ID.test(r.id)) return false;
                    if (typeof r.fecha !== 'string' || !REGEX_PATTERNS.FECHA.test(r.fecha)) return false;
                    if (!validarFechaSegura(r.fecha)) return false;
                    if (r.entrada !== null) {
                        if (typeof r.entrada !== 'string' || !REGEX_PATTERNS.HORA.test(r.entrada)) return false;
                    }
                    if (r.salida !== null) {
                        if (typeof r.salida !== 'string' || !REGEX_PATTERNS.HORA.test(r.salida)) return false;
                    }

                    if (r.tiempoFuera !== null && r.tiempoFuera !== '') {
                        if (typeof r.tiempoFuera !== 'string' || !REGEX_PATTERNS.HORA.test(r.tiempoFuera)) return false;
                    }

                    if (!Number.isFinite(r.horas) || r.horas < 0 || r.horas > 24) return false;
                    if (!Number.isFinite(r.minutos) || r.minutos < 0 || r.minutos > 59) return false;
                    if (!Number.isFinite(r.total) || r.total < 0 || r.total > 24) return false;

                    const propiedadesPermitidas = ['id', 'fecha', 'entrada', 'salida', 'tiempoFuera', 'horas', 'minutos', 'total'];
                    const propiedadesActuales = Object.keys(r);
                    const tienePropiedadesSospechosas = propiedadesActuales.some(prop => !propiedadesPermitidas.includes(prop));
                    if (tienePropiedadesSospechosas) return false;

                    return true;
                }
                return {
                    SECURITY_LIMITS,
                    REGEX_PATTERNS,
                    saveLimiter,
                    sanitizeString,
                    validarFechaSegura,
                    validarHoraSegura,
                    generarIDSeguro,
                    calcularHashFNV1a,
                    validarRegistroSeguro
                };
            })();

            // ====================================================================
            // HISTORY MANAGER MODULE
            // ====================================================================
            const HistoryManager = (function () {
                let history = [];
                let currentIndex = -1;
                const MAX_HISTORY = 50;

                // Funci√≥n auxiliar para copia profunda segura
                function deepClone(obj) {
                    return JSON.parse(JSON.stringify(obj));
                }

                function saveState(registros) {
                    // CR√çTICO: Hacer copia profunda INMEDIATAMENTE
                    const copiaSegura = deepClone(registros);

                    // Si estamos en medio del historial (despu√©s de un undo),
                    // eliminar todos los estados "futuros"
                    if (currentIndex < history.length - 1) {
                        history.splice(currentIndex + 1);
                    }

                    // Guardar la copia profunda
                    history.push(copiaSegura);

                    // Limitar tama√±o del historial
                    if (history.length > MAX_HISTORY) {
                        history.shift();
                        currentIndex = MAX_HISTORY - 1;
                    } else {
                        currentIndex = history.length - 1;
                    }

                    updateButtons();

                    //console.log('Estado guardado. Historial:', history.length, 'Index:', currentIndex);
                }

                function undo() {
                    if (currentIndex > 0) {
                        currentIndex--;
                        updateButtons();
                        const estado = deepClone(history[currentIndex]);
                        console.log('Undo a index:', currentIndex);
                        return estado;
                    }
                    return null;
                }

                function redo() {
                    if (currentIndex < history.length - 1) {
                        currentIndex++;
                        updateButtons();
                        const estado = deepClone(history[currentIndex]);
                        // console.log('Redo a index:', currentIndex);
                        return estado;
                    }
                    return null;
                }

                function canUndo() {
                    return currentIndex > 0;
                }

                function canRedo() {
                    return currentIndex < history.length - 1;
                }

                function updateButtons() {
                    const undoBtn = document.getElementById('btn-undo');
                    const redoBtn = document.getElementById('btn-redo');

                    if (undoBtn) undoBtn.disabled = !canUndo();
                    if (redoBtn) redoBtn.disabled = !canRedo();
                }

                function clear() {
                    history = [];
                    currentIndex = -1;
                    updateButtons();
                }

                // ‚úÖ NUEVO: M√©todo para debug
                function getDebugInfo() {
                    return {
                        historyLength: history.length,
                        currentIndex: currentIndex,
                        canUndo: canUndo(),
                        canRedo: canRedo()
                    };
                }

                return {
                    saveState,
                    undo,
                    redo,
                    canUndo,
                    canRedo,
                    updateButtons,
                    clear,
                    getDebugInfo // ‚úÖ Para debugging
                };
            })();

            // ====================================================================
            // II. DATA MANAGEMENT MODULE (CORREGIDO)
            // ====================================================================
            const DataManagement = (function (S) {
                let registros = [], diasHabiles = 5, horasDiarias = 7, editandoId = null;
                let vistaActual = 'diaria', registrosVisibles = 10;
                let cacheSemana = { inicio: null, fin: null, calculado: null };

                function cargarConVerificacion() {
                    try {
                        const stored = localStorage.getItem('registros');
                        if (!stored) return [];
                        const data = JSON.parse(stored);
                        if (data.hash) {
                            const hashCalculado = S.calcularHashFNV1a(data.registros);
                            if (hashCalculado !== data.hash) {
                                console.warn('‚ö†Ô∏è Integridad comprometida');
                                UILogic.mostrarToast('Advertencia de integridad', 'warning');
                                const continuar = confirm('‚ö†Ô∏è Los datos pueden haber sido modificados.\n\n¬øDeseas cargarlos de todos modos?');
                                if (!continuar) {
                                    localStorage.removeItem('registros');
                                    return [];
                                }
                            }
                        }
                        return (data.registros || []).filter(S.validarRegistroSeguro);
                    } catch (e) {
                        console.error('Error cargando:', e);
                        return [];
                    }
                }

                function guardarConIntegridad(regs) {
                    if (!S.saveLimiter.canProceed()) {
                        UILogic.mostrarToast('Demasiadas operaciones, espera un momento', 'warning');
                        return false;
                    }
                    try {
                        const hash = S.calcularHashFNV1a(regs);
                        const data = { registros: regs, hash, timestamp: Date.now(), version: S.SECURITY_LIMITS.SCHEMA_VERSION };
                        const str = JSON.stringify(data);
                        const size = new Blob([str]).size;
                        if (size > S.SECURITY_LIMITS.MAX_JSON_SIZE) {
                            UILogic.mostrarToast('Almacenamiento lleno', 'error');
                            return false;
                        }
                        localStorage.setItem('registros', str);
                        return true;
                    } catch (e) {
                        console.error('Error guardando:', e);
                        if (e.name === 'QuotaExceededError') {
                            UILogic.mostrarToast('Espacio lleno', 'error');
                        }
                        return false;
                    }
                }

                function guardarYActualizar(actualizarRegistros = true) {
                    let saveSuccessful = true;
                    if (actualizarRegistros) {
                        saveSuccessful = guardarConIntegridad(registros);
                    }
                    if (saveSuccessful) {
                        UILogic.actualizarUI();
                    }
                    return saveSuccessful;
                }

                function cargarConfiguracion() {
                    try {
                        const d = parseFloat(localStorage.getItem('diasHabiles'));
                        const hd = parseFloat(localStorage.getItem('horasDiarias'));

                        let diasCalculados = 5;
                        if (isNaN(d)) {
                            const hsAntiguas = parseFloat(localStorage.getItem('horasSemanales'));
                            if (!isNaN(hsAntiguas) && !isNaN(hd) && hd > 0) {
                                diasCalculados = Math.round(hsAntiguas / hd);
                                if (diasCalculados < 1) diasCalculados = 1;
                                if (diasCalculados > 7) diasCalculados = 7;
                            }
                        }

                        let t = localStorage.getItem('temaOscuro') === 'true';
                        if (localStorage.getItem('temaOscuro') === null) {
                            t = true;
                        }

                        const v = localStorage.getItem('vistaActual');
                        return {
                            diasHabiles: (!isNaN(d) && d >= 1 && d <= 7) ? d : diasCalculados,
                            horasDiarias: (hd >= 1 && hd <= 24) ? hd : 7,
                            temaOscuro: t,
                            vistaActual: (v === 'semana' || v === 'diaria') ? v : 'diaria'
                        };
                    } catch (e) {
                        return { diasHabiles: 5, horasDiarias: 7, temaOscuro: true, vistaActual: 'diaria' };
                    }
                }

                function tiempoEnMinutos(h) {
                    if (!h || !h.includes(':')) return 0;
                    const [hr, mn] = h.split(':').map(Number);
                    return (hr * 60) + mn;
                }

                function calcularHoras(e, s, tf = null) {
                    const tfMinutos = tf ? tiempoEnMinutos(tf) : 0;

                    if (e === '00:00' && s === '00:00') {
                        const minFeriado = horasDiarias * 60;
                        return { horas: Math.floor(minFeriado / 60), minutos: Math.round(minFeriado % 60), total: horasDiarias };
                    }

                    if (!e || !s || !e.includes(':') || !s.includes(':')) return null;

                    const [hE, mE] = e.split(':').map(Number);
                    const [hS, mS] = s.split(':').map(Number);

                    let minTotal = (hS * 60 + mS) - (hE * 60 + mE);

                    if (minTotal < 0) minTotal += 24 * 60;

                    let minNeto = minTotal - tfMinutos;
                    if (minNeto < 0) minNeto = 0;

                    return { horas: Math.floor(minNeto / 60), minutos: minNeto % 60, total: minNeto / 60 };
                }

                function calcularHorasFeriadoEnRango(inicio, fin) {
                    const horasDiariasLocal = horasDiarias;
                    let horasDescontar = 0;

                    registros.forEach(r => {
                        if (r.fecha >= inicio && r.fecha <= fin && r.entrada === '00:00' && r.salida === '00:00') {
                            horasDescontar += horasDiariasLocal;
                        }
                    });
                    return horasDescontar;
                }

                function validarFormulario() {
                    let valido = true;
                    const fecha = $('fecha').value;
                    const entrada = $('entrada').value.trim();
                    const salida = $('salida').value.trim();

                    UILogic.limpiarError('fecha', 'error-fecha');
                    UILogic.limpiarError('entrada', 'error-entrada');
                    UILogic.limpiarError('salida', 'error-salida');

                    if (!fecha || !S.validarFechaSegura(fecha)) {
                        UILogic.mostrarError('fecha', 'error-fecha');
                        valido = false;
                    }
                    if (entrada && !S.validarHoraSegura(entrada)) {
                        UILogic.mostrarError('entrada', 'error-entrada');
                        valido = false;
                    }
                    if (salida && !S.validarHoraSegura(salida)) {
                        UILogic.mostrarError('salida', 'error-salida');
                        valido = false;
                    }
                    return valido;
                }
                function agregarRegistro() {
                    if (!validarFormulario()) {
                        UILogic.mostrarToast('Verifica los campos', 'error');
                        return;
                    }

                    const btn = $('btn-agregar');
                    btn.disabled = true;

                    const f = S.sanitizeString($('fecha').value, 10);
                    const e = S.sanitizeString($('entrada').value.trim(), 5);
                    const s = S.sanitizeString($('salida').value.trim(), 5);

                    if (!e && !s) {
                        UILogic.resetearBoton(btn);
                        UILogic.mostrarToast('Rellena algun campo', 'error');
                        return;
                    }

                    const registroExistente = registros.find(r => r.fecha === f);

                    if (!e && s) {
                        if (!registroExistente || registroExistente.salida) {
                            UILogic.resetearBoton(btn);
                            UILogic.mostrarToast('Debes registrar una entrada primero', 'error');
                            return;
                        }
                    }

                    if (registroExistente && (!e || !s)) {
                        if (!e && s && registroExistente.entrada && !registroExistente.salida) {
                            UILogic.resetearBoton(btn);
                            if (confirm(`Ya existe una entrada a las ${registroExistente.entrada}. ¬øAgregar salida ${s}?`)) {
                                registroExistente.salida = s;
                                let t = calcularHoras(registroExistente.entrada, s, registroExistente.tiempoFuera || null);
                                registroExistente.horas = t?.horas || 0;
                                registroExistente.minutos = t?.minutos || 0;
                                registroExistente.total = t?.total || 0;

                                HistoryManager.saveState(registros);

                                const saved = guardarYActualizar();
                                if (saved) {
                                    UILogic.mostrarToast('Salida agregada', 'success');
                                    UILogic.resetearBoton(btn);
                                    $('fecha').value = UILogic.obtenerFechaHoy();
                                    $('salida').value = '';
                                } else {
                                    UILogic.resetearBoton(btn);
                                }
                                return;
                            }
                            return;
                        } else {
                            UILogic.resetearBoton(btn);
                            UILogic.mostrarToast('Ya existe un registro para esta fecha', 'error');
                            return;
                        }
                    }

                    if (registroExistente) {
                        UILogic.resetearBoton(btn);
                        UILogic.mostrarToast('Ya existe un registro para esta fecha', 'error');
                        return;
                    }

                    if (registros.length >= S.SECURITY_LIMITS.MAX_REGISTROS) {
                        UILogic.resetearBoton(btn);
                        UILogic.mostrarToast('L√≠mite alcanzado', 'error');
                        return;
                    }

                    const t = calcularHoras(e || null, s || null, null);
                    registros.push({
                        id: S.generarIDSeguro(),
                        fecha: f,
                        entrada: e || null,
                        salida: s || null,
                        tiempoFuera: null,
                        horas: t?.horas || 0,
                        minutos: t?.minutos || 0,
                        total: t?.total || 0
                    });
                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return new Date(b.fecha) - new Date(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    const saved = guardarYActualizar();
                    if (saved) {
                        UILogic.mostrarToast('Registro agregado', 'success');
                        UILogic.resetearBoton(btn);
                        $('fecha').value = UILogic.obtenerFechaHoy();
                        $('entrada').value = '';
                        $('salida').value = '';
                    } else {
                        UILogic.resetearBoton(btn);
                    }
                }

                function eliminarRegistroActual() {
                    if (editandoId && confirm('¬øEliminar este registro?')) {
                        const modal = $('modal-editar');
                        const btnEliminar = modal.querySelector('.btn-delete');
                        btnEliminar.disabled = true;

                        registros = registros.filter(r => r.id !== editandoId);
                        HistoryManager.saveState(registros);

                        const saved = guardarYActualizar();
                        btnEliminar.disabled = false;
                        btnEliminar.innerHTML = '<svg class="icon"><use href="#icon-trash"/></svg> Eliminar';

                        if (saved) {
                            UILogic.mostrarToast('Registro eliminado', 'success');
                            UILogic.cerrarEdicion();
                        }
                    }
                }

                function editarRegistro(id) {
                    if (editandoId !== null) return;
                    const r = registros.find(x => x.id === id);
                    if (!r) return;
                    editandoId = id;
                    $('edit-fecha').value = r.fecha;
                    $('edit-entrada').value = r.entrada || '';
                    $('edit-salida').value = r.salida || '';
                    $('edit-tiempo-fuera').value = r.tiempoFuera || '';
                    $('modal-editar').classList.add('show');
                }
                function guardarEdicion() {
                    const r = registros.find(x => x.id === editandoId);
                    if (!r) return;

                    const modal = $('modal-editar');
                    const btnGuardar = modal.querySelector('.btn-edit');
                    btnGuardar.disabled = true;

                    const f = S.sanitizeString($('edit-fecha').value, 10);
                    const e = S.sanitizeString($('edit-entrada').value.trim(), 5);
                    const s = S.sanitizeString($('edit-salida').value.trim(), 5);
                    let tf = S.sanitizeString($('edit-tiempo-fuera').value.trim(), 5);
                    if (tf === '') tf = null;

                    if (!S.validarFechaSegura(f) || (e && !S.validarHoraSegura(e)) || (s && !S.validarHoraSegura(s)) || (tf && !S.validarHoraSegura(tf))) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Verifica los campos', 'error');
                        return;
                    }

                    if (!e && s) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Debes registrar una entrada primero', 'error');
                        return;
                    }

                    const existeFecha = registros.some(reg => reg.fecha === f && reg.id !== editandoId);
                    if (existeFecha) {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.mostrarToast('Ya existe otro registro', 'error');
                        return;
                    }

                    r.fecha = f;
                    r.entrada = e || null;
                    r.salida = s || null;
                    r.tiempoFuera = tf;
                    const t = calcularHoras(r.entrada, r.salida, r.tiempoFuera);
                    r.horas = t?.horas || 0;
                    r.minutos = t?.minutos || 0;
                    r.total = t?.total || 0;
                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return new Date(b.fecha) - new Date(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    const saved = guardarYActualizar();

                    if (saved) {
                        UILogic.mostrarToast('Registro actualizado', 'success');
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                        UILogic.cerrarEdicion();
                    } else {
                        UILogic.restaurarBotonGuardarEdicion(btnGuardar);
                    }
                }

                function guardarConfig() {
                    const d = parseFloat($('config-dias-habiles').value);
                    const vd = parseFloat($('config-horas-diarias').value);

                    if (isNaN(d) || d < 1 || d > 7) {
                        UILogic.mostrarToast('D√≠as h√°biles inv√°lidos', 'error');
                        return;
                    }
                    if (isNaN(vd) || vd < 1 || vd > 24) {
                        UILogic.mostrarToast('Horas diarias inv√°lidas', 'error');
                        return;
                    }

                    diasHabiles = d;
                    horasDiarias = vd;

                    registros.forEach(r => {
                        if (r.entrada === '00:00' && r.salida === '00:00') {
                            const t = calcularHoras('00:00', '00:00', r.tiempoFuera || null);
                            r.horas = t?.horas || 0;
                            r.minutos = t?.minutos || 0;
                            r.total = t?.total || 0;
                        }
                    });

                    try {
                        localStorage.setItem('diasHabiles', diasHabiles);
                        localStorage.setItem('horasDiarias', horasDiarias);
                        localStorage.removeItem('horasSemanales');
                    } catch (e) {
                        UILogic.mostrarToast('Error al guardar', 'error');
                        return;
                    }
                    guardarYActualizar(true);
                    UILogic.mostrarToast('Configuraci√≥n guardada', 'success');
                    UILogic.cerrarConfig();
                }

                function borrarTodoHistorial() {
                    const totalRegistros = registros.length;
                    if (totalRegistros === 0) {
                        UILogic.mostrarToast('No hay registros para borrar', 'info');
                        return;
                    }

                    // --- CONFIRMACI√ìN SIMPLE ---
                    const confirmar = confirm(`‚ö†Ô∏è ¬øEST√ÅS SEGURO?\n\nEsto eliminar√° TODOS los ${totalRegistros} registros \n\Esta accion se puede DESHACER antes de cerrar la pagina.`);

                    if (!confirmar) return;
                    // --- FIN CONFIRMACI√ìN SIMPLE ---

                    registros = [];
                    registrosVisibles = 10;

                    HistoryManager.saveState(registros);

                    if (guardarConIntegridad(registros)) {
                        UILogic.actualizarUI();
                        UILogic.mostrarToast(`${totalRegistros} registros eliminados`, 'success');
                        UILogic.cerrarConfig();
                    }
                }

                function cargarMasRegistros() {
                    const totalRestantes = registros.length - registrosVisibles;
                    if (totalRestantes > 0) {
                        registrosVisibles += 10;
                        if (registrosVisibles > registros.length) {
                            registrosVisibles = registros.length;
                        }
                        UILogic.actualizarUI();
                        $('btn-cargar-mas').scrollIntoView({ behavior: 'smooth', block: 'end' });
                    }
                }

                function exportarJSON() {
                    const data = { registros, diasHabiles, horasDiarias, fecha: new Date().toISOString(), version: S.SECURITY_LIMITS.SCHEMA_VERSION };
                    try {
                        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `horarios_v3.7_${new Date().toISOString().split('T')[0]}.json`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(url);
                        UILogic.mostrarToast('Datos exportados', 'success');
                    } catch (e) {
                        UILogic.mostrarToast('Error al exportar', 'error');
                    }
                }

                function importarDatos(modo = 'replace') {
                    const fileInput = $('file-import');
                    const file = fileInput.files[0];

                    if (!file) {
                        UILogic.mostrarToast('Selecciona un archivo primero', 'error');
                        return;
                    }
                    if (file.size > S.SECURITY_LIMITS.MAX_JSON_SIZE) {
                        UILogic.mostrarToast('Archivo muy grande', 'error');
                        return;
                    }

                    //Validar tipo MIME
                    if (file.type && file.type !== 'application/json') {
                        UILogic.mostrarToast('Solo se permiten archivos JSON', 'error');
                        return;
                    }

                    const reader = new FileReader();
                    reader.onload = (e) => {
                        try {
                            //Validar que el contenido no est√© vac√≠o
                            const contenido = e.target.result;
                            if (!contenido || contenido.trim().length === 0) {
                                UILogic.mostrarToast('Archivo vac√≠o', 'error');
                                return;
                            }

                            const data = JSON.parse(contenido);

                            //Validaci√≥n estricta de estructura
                            if (!data || typeof data !== 'object' || Array.isArray(data)) {
                                UILogic.mostrarToast('Estructura de archivo inv√°lida', 'error');
                                return;
                            }

                            if (!data.registros || !Array.isArray(data.registros)) {
                                UILogic.mostrarToast('Archivo inv√°lido o corrupto', 'error');
                                return;
                            }

                            //Validar l√≠mite de registros antes de procesar
                            if (data.registros.length > S.SECURITY_LIMITS.MAX_REGISTROS) {
                                UILogic.mostrarToast(`M√°ximo ${S.SECURITY_LIMITS.MAX_REGISTROS} registros permitidos`, 'error');
                                return;
                            }

                            //Filtrar y normalizar datos
                            const registrosImportados = data.registros.filter(r => {
                                // Asegurar que tiempoFuera exista y sea null o string
                                if (!r.hasOwnProperty('tiempoFuera')) r.tiempoFuera = null;
                                if (r.tiempoFuera === '') r.tiempoFuera = null;

                                //Normalizar tipos num√©ricos
                                if (typeof r.horas === 'string') r.horas = parseFloat(r.horas);
                                if (typeof r.minutos === 'string') r.minutos = parseFloat(r.minutos);
                                if (typeof r.total === 'string') r.total = parseFloat(r.total);

                                return S.validarRegistroSeguro(r);
                            });

                            if (registrosImportados.length === 0) {
                                UILogic.mostrarToast('No se encontraron registros v√°lidos', 'warning');
                                return;
                            }

                            // Recalcular horas para asegurar consistencia
                            registrosImportados.forEach(r => {
                                const t = calcularHoras(r.entrada, r.salida, r.tiempoFuera || null);
                                r.horas = t?.horas || 0;
                                r.minutos = t?.minutos || 0;
                                r.total = t?.total || 0;
                            });

                            // --- MODO REEMPLAZAR ---
                            if (modo === 'replace') {
                                const confirmMsg = `‚ö†Ô∏è ATENCI√ìN\n\nSe borrar√°n tus datos actuales y se reemplazar√°n por ${registrosImportados.length} registros del archivo.\n\n¬øEst√°s seguro?`;
                                if (!confirm(confirmMsg)) return;

                                registros = registrosImportados;

                                //Validaci√≥n estricta de tipos de configuraci√≥n
                                if (data.diasHabiles !== undefined) {
                                    const diasParsed = typeof data.diasHabiles === 'string' ? parseFloat(data.diasHabiles) : data.diasHabiles;
                                    if (Number.isFinite(diasParsed) && diasParsed >= 1 && diasParsed <= 7) {
                                        diasHabiles = diasParsed;
                                    }
                                }

                                if (data.horasDiarias !== undefined) {
                                    const horasParsed = typeof data.horasDiarias === 'string' ? parseFloat(data.horasDiarias) : data.horasDiarias;
                                    if (Number.isFinite(horasParsed) && horasParsed >= 1 && horasParsed <= 24) {
                                        horasDiarias = horasParsed;
                                    }
                                }

                                finalizarImportacionAndSave(`Se reemplazaron los datos por ${registrosImportados.length} registros.`);
                            }

                            // --- MODO COMBINAR ---
                            else if (modo === 'merge') {
                                const fechasExistentes = new Set(registros.map(r => r.fecha));
                                const nuevos = registrosImportados.filter(imp => !fechasExistentes.has(imp.fecha));

                                if (nuevos.length === 0) {
                                    UILogic.mostrarToast('No hay d√≠as nuevos para agregar', 'info');
                                    return;
                                }

                                //Validar que no se exceda el l√≠mite total
                                if (registros.length + nuevos.length > S.SECURITY_LIMITS.MAX_REGISTROS) {
                                    UILogic.mostrarToast(`L√≠mite alcanzado. Solo se pueden agregar ${S.SECURITY_LIMITS.MAX_REGISTROS - registros.length} registros m√°s`, 'error');
                                    return;
                                }

                                registros = registros.concat(nuevos);
                                finalizarImportacionAndSave(`Se combinaron datos. ${nuevos.length} d√≠as nuevos agregados.`);
                            }

                        } catch (err) {
                            console.error('Error en importaci√≥n:', err);
                            // Mensaje m√°s espec√≠fico
                            if (err instanceof SyntaxError) {
                                UILogic.mostrarToast('Archivo JSON mal formado', 'error');
                            } else {
                                UILogic.mostrarToast('Error al procesar el archivo', 'error');
                            }
                        }
                    };

                    // Manejar errores de lectura
                    reader.onerror = () => {
                        UILogic.mostrarToast('Error al leer el archivo', 'error');
                    };

                    reader.readAsText(file);
                }

                function finalizarImportacionAndSave(mensajeExito) {
                    registros.sort((a, b) => {
                        if (a.fecha !== b.fecha) return new Date(b.fecha) - new Date(a.fecha);
                        return (b.entrada || '').localeCompare(a.entrada || '');
                    });

                    HistoryManager.saveState(registros);

                    if (guardarYActualizar()) {
                        try {
                            localStorage.setItem('diasHabiles', diasHabiles);
                            localStorage.setItem('horasDiarias', horasDiarias);
                        } catch (ex) { }

                        UILogic.mostrarToast(mensajeExito, 'success');
                        UILogic.cerrarImportar();
                        $('file-import').value = '';
                    }
                }

                function calcularBufferSemanal(inicioSemana, fechaHoy) {
                    let buffer = 0;
                    // Normalizar fechas
                    let fechaIteracion = new Date(inicioSemana.replace(/-/g, '/') + ' 00:00:00');
                    let fechaLimite = new Date(fechaHoy.replace(/-/g, '/') + ' 00:00:00');

                    while (fechaIteracion <= fechaLimite) {
                        const y = fechaIteracion.getFullYear();
                        const m = String(fechaIteracion.getMonth() + 1).padStart(2, '0');
                        const d = String(fechaIteracion.getDate()).padStart(2, '0');
                        const isoDate = `${y}-${m}-${d}`;

                        // 0 = Domingo, 1 = Lunes ... 6 = S√°bado
                        const numDia = fechaIteracion.getDay();

                        // Determinar si es d√≠a laboral basado en la config
                        let esDiaLaboralConfigurado = false;

                        if (numDia === 0) {
                            esDiaLaboralConfigurado = (diasHabiles === 7);
                        } else {
                            esDiaLaboralConfigurado = (numDia <= diasHabiles);
                        }

                        const r = registros.find(reg => reg.fecha === isoDate);
                        let horasObjetivoDia = 0;
                        let horasHechasDia = 0;

                        const esFeriado = r && r.entrada === '00:00' && r.salida === '00:00';
                        const tieneSalida = r && r.salida && !esFeriado;
                        const esDiaPasado = isoDate < fechaHoy;

                        // 1. Objetivo: Solo cuenta si es pasado o si HOY ya cerraste turno (tiene salida)
                        if (esDiaLaboralConfigurado && !esFeriado && (esDiaPasado || (isoDate === fechaHoy && tieneSalida))) {
                            horasObjetivoDia = horasDiarias;
                        }

                        // 2. Hechas: Solo contamos si hay salida.
                        // ELIMINADO: El c√°lculo "en vivo" (else if r.entrada...) para que no afecte al buffer.
                        if (r && !esFeriado) {
                            if (r.salida) {
                                horasHechasDia = r.total;
                            }
                        }

                        buffer += (horasHechasDia - horasObjetivoDia);
                        fechaIteracion.setDate(fechaIteracion.getDate() + 1);
                    }
                    return buffer;
                }

                return {
                    registros: () => registros,
                    horasSemanales: () => (horasDiarias * diasHabiles),
                    diasHabiles: () => diasHabiles,
                    horasDiarias: () => horasDiarias,
                    setDiasHabiles: (v) => diasHabiles = v,
                    setHorasDiarias: (v) => horasDiarias = v,
                    editandoId: () => editandoId,
                    setEditandoId: (id) => editandoId = id,
                    vistaActual: () => vistaActual,
                    setVistaActual: (v) => vistaActual = v,
                    registrosVisibles: () => registrosVisibles,
                    setRegistrosVisibles: (v) => registrosVisibles = v,
                    cacheSemana: () => cacheSemana,
                    setCacheSemana: (c) => cacheSemana = c,
                    cargarConVerificacion,
                    cargarConfiguracion,
                    calcularHoras,
                    calcularHorasFeriadoEnRango,
                    guardarYActualizar,
                    agregarRegistro,
                    eliminarRegistroActual,
                    editarRegistro,
                    guardarEdicion,
                    guardarConfig,
                    borrarTodoHistorial,
                    cargarMasRegistros,
                    exportarJSON,
                    importarDatos,
                    calcularBufferSemanal,
                    undoAction: function () {
                        const prevState = HistoryManager.undo();
                        if (prevState) {
                            registros.splice(0, registros.length, ...prevState);
                            guardarYActualizar();
                            UILogic.mostrarToast('Deshecho', 'info');
                        }
                    },
                    redoAction: function () {
                        const nextState = HistoryManager.redo();
                        if (nextState) {
                            registros.splice(0, registros.length, ...nextState);
                            guardarYActualizar();
                            UILogic.mostrarToast('Rehecho', 'info');
                        }
                    }
                };

            })(SecurityAndUtils);
            // ====================================================================
            // III. UI LOGIC MODULE
            // ====================================================================
            const UILogic = (function (S, D) {

                function mostrarError(inputId, errorId) {
                    const input = $(inputId);
                    const error = $(errorId);
                    if (input) input.classList.add('error');
                    if (error) error.style.display = 'block';
                }

                function limpiarError(inputId, errorId) {
                    const input = $(inputId);
                    const error = $(errorId);
                    if (input) input.classList.remove('error');
                    if (error) error.style.display = 'none';
                }

                function mostrarToast(mensaje, tipo = 'info') {
                    const toast = $('toast');
                    const textoLimpio = S.sanitizeString(mensaje, 200);
                    toast.textContent = textoLimpio;
                    toast.className = `toast ${tipo}`;
                    setTimeout(() => toast.classList.add('show'), 10);
                    setTimeout(() => {
                        toast.classList.remove('show');
                    }, 3000);
                }

                function resetearBoton(btn) {
                    btn.disabled = false;
                    btn.innerHTML = '<svg class="icon"><use href="#icon-save"/></svg> Registrar';
                }

                function restaurarBotonGuardarEdicion(btnGuardar) {
                    btnGuardar.disabled = false;
                    btnGuardar.innerHTML = '<svg class="icon"><use href="#icon-save"/></svg> Guardar';
                }

                function obtenerFechaHoy() {
                    const now = new Date();
                    return `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}`;
                }

                function obtenerNombreDia(f) {
                    if (!f) return '';
                    const dias = ['Domingo', 'Lunes', 'Martes', 'Mi√©rcoles', 'Jueves', 'Viernes', 'S√°bado'];
                    try {
                        const [y, m, d] = f.split('-').map(Number);
                        const date = new Date(y, m - 1, d);
                        if (isNaN(date.getTime())) return '';
                        return dias[date.getDay()];
                    } catch (e) { return ''; }
                }

                function obtenerSemanaActual() {
                    const cache = D.cacheSemana();
                    const hoy = new Date().toDateString();
                    if (cache.calculado === hoy) return { inicio: cache.inicio, fin: cache.fin };
                    const now = new Date();
                    const dia = now.getDay();
                    const offset = dia === 0 ? -6 : 1 - dia;
                    const lun = new Date(now);
                    lun.setDate(now.getDate() + offset);
                    lun.setHours(0, 0, 0, 0);
                    const vie = new Date(lun);
                    vie.setDate(lun.getDate() + 4);
                    vie.setHours(23, 59, 59, 999);
                    const inicio = lun.toISOString().split('T')[0];
                    const fin = vie.toISOString().split('T')[0];
                    D.setCacheSemana({ inicio, fin, calculado: hoy });
                    return { inicio, fin };
                }

                function horasATexto(t) {
                    const totalHoras = Math.max(0, t);

                    const h = Math.floor(totalHoras);
                    const m = Math.round((totalHoras - h) * 60);

                    let partes = [];

                    if (h > 0) {
                        partes.push(`${h} ${h === 1 ? 'hora' : 'horas'}`);
                    }

                    if (m > 0) {
                        partes.push(`${m} ${m === 1 ? 'minuto' : 'minutos'}`);
                    } else if (h === 0 && m === 0) {
                        partes.push('0 minutos');
                    }

                    return partes.join(' ');
                }

                function formatoDiferencia(tiempoTotalHoras) {
                    const horasDiarias = D.horasDiarias();
                    const objetivoMinutos = horasDiarias * 60;
                    const actualMinutos = Math.round(tiempoTotalHoras * 60);
                    let diferenciaMinutos = actualMinutos - objetivoMinutos;
                    if (diferenciaMinutos === 0) return '';
                    const signo = diferenciaMinutos > 0 ? '+' : '-';
                    const absMinutos = Math.abs(diferenciaMinutos);
                    const h = Math.floor(absMinutos / 60);
                    const m = absMinutos % 60;
                    let diferenciaTexto = '';
                    if (h > 0) diferenciaTexto += `${h}h`;
                    if (m > 0 || h === 0) {
                        if (h > 0) diferenciaTexto += ' ';
                        diferenciaTexto += `${m}m`;
                    }
                    if (diferenciaTexto === '') return '';
                    return `${signo}${diferenciaTexto}`;
                }

                function formatoTituloMes(claveMes) {
                    const [a√±o, mes] = claveMes.split('-');
                    const fecha = new Date(a√±o, mes - 1, 1);
                    const opciones = { month: 'long', year: 'numeric' };
                    let nombre = fecha.toLocaleDateString('es-ES', opciones);
                    return nombre.charAt(0).toUpperCase() + nombre.slice(1);
                }

                function agruparRegistrosPorMes(registros) {
                    const grupos = new Map();
                    registros.forEach(r => {
                        const claveMes = r.fecha.substring(0, 7);
                        if (!grupos.has(claveMes)) {
                            grupos.set(claveMes, []);
                        }
                        grupos.get(claveMes).push(r);
                    });
                    return grupos;
                }

                function setProgressBarColor(progressEl, status) {
                    if (!progressEl) return;
                    progressEl.classList.remove('blue', 'green', 'red');
                    progressEl.classList.add(status);
                }
                function actualizarListaRegistros(registros) {
                    const lista = $('lista-registros');
                    const btnCargarMas = $('btn-cargar-mas');
                    lista.innerHTML = '';
                    const horasDiarias = D.horasDiarias();

                    const registrosAMostrar = registros.slice(0, D.registrosVisibles());
                    if (registrosAMostrar.length === 0) {
                        lista.innerHTML = '<div class="empty-state">No hay registros</div>';
                        btnCargarMas.style.display = 'none';
                        return;
                    }

                    if (registros.length > D.registrosVisibles()) {
                        const restantes = registros.length - D.registrosVisibles();
                        const aCargar = Math.min(10, restantes);
                        btnCargarMas.textContent = `Cargar m√°s (${aCargar} restantes)`;
                        btnCargarMas.style.display = 'block';
                    } else {
                        btnCargarMas.style.display = 'none';
                    }

                    const gruposPorMes = agruparRegistrosPorMes(registrosAMostrar);
                    const fragmento = document.createDocumentFragment();

                    gruposPorMes.forEach((registrosDelMes, claveMes) => {
                        const tituloGrupo = document.createElement('h3');
                        tituloGrupo.className = 'registro-grupo-titulo';
                        tituloGrupo.textContent = formatoTituloMes(claveMes);
                        fragmento.appendChild(tituloGrupo);

                        registrosDelMes.forEach(r => {
                            const item = document.createElement('div');
                            const hoy = obtenerFechaHoy();
                            item.className = r.fecha === hoy ? 'registro-item hoy' : 'registro-item';
                            item.onclick = () => D.editarRegistro(r.id);
                            const info = document.createElement('div');
                            info.className = 'registro-info';
                            const isFeriadoContabilizado = r.entrada === '00:00' && r.salida === '00:00';
                            const fechaEl = document.createElement('div');
                            fechaEl.className = 'registro-fecha';
                            fechaEl.textContent = `${obtenerNombreDia(r.fecha)} ${r.fecha.substring(8)}${isFeriadoContabilizado ? ' ü•≥ (Feriado)' : ''}`;
                            const tfText = r.tiempoFuera && r.tiempoFuera !== '' ? ` (${r.tiempoFuera} Fuera)` : '';
                            const horasEl = document.createElement('div');
                            horasEl.className = 'registro-horas';
                            horasEl.textContent = isFeriadoContabilizado ? 'D√≠a no laboral' : `${r.entrada || '-'} ‚Üí ${r.salida || '-'}${tfText}`;
                            const totalEl = document.createElement('div');
                            totalEl.className = 'registro-total';
                            let totalText = 'Incompleto';
                            totalEl.classList.remove('green-text', 'red-text');

                            if (isFeriadoContabilizado) {
                                totalText = 'Horas descontadas';
                                totalEl.classList.add('green-text');
                            } else if (r.entrada && r.salida) {
                                totalText = `${r.horas}h ${r.minutos}m`;
                                const diffText = formatoDiferencia(r.total);
                                if (r.total >= horasDiarias) {
                                    totalEl.classList.add('green-text');
                                } else {
                                    totalEl.classList.add('red-text');
                                }
                                if (diffText) totalText += ` (${diffText})`;
                            }

                            totalEl.textContent = totalText;
                            info.appendChild(fechaEl);
                            info.appendChild(horasEl);
                            info.appendChild(totalEl);
                            item.appendChild(info);
                            fragmento.appendChild(item);
                        });
                    });
                    lista.appendChild(fragmento);
                }

                function esFinDeSemana() {
                    const d = new Date().getDay();
                    return d === 0 || d === 6;
                }

                function actualizarUI() {
                    const registros = D.registros();
                    const horasSemanales = D.horasSemanales();
                    const horasDiarias = D.horasDiarias();
                    // 1. OBTENER LA CONFIGURACI√ìN REAL DE D√çAS H√ÅBILES
                    const diasHabilesConfig = D.diasHabiles();
                    const vistaActual = D.vistaActual();

                    actualizarListaRegistros(registros);

                    const { inicio: ini, fin: fn } = obtenerSemanaActual();
                    const hoy = obtenerFechaHoy();

                    // 2. CALCULAR BUFFER
                    const bufferSemanal = D.calcularBufferSemanal(ini, hoy);

                    const statsEl = $('stats-semana');
                    const progressEl = $('progress-bar');
                    const mensajeEl = $('stats-mensaje');
                    const tituloEl = $('stats-titulo');
                    const hintEl = $('toggle-hint');
                    const bufferEl = $('stats-buffer');

                    // 3. RENDERIZAR BUFFER
                    if (bufferEl) {
                        bufferEl.innerHTML = '';
                        if (bufferSemanal !== 0) {
                            if (Math.abs(bufferSemanal) > 0.01) {
                                const esPositivo = bufferSemanal > 0;
                                const bufferIcono = esPositivo ? '‚úÖ' : '‚ö†Ô∏è';
                                const bufferColor = esPositivo ? '#60ac94' : '#c05d76';
                                const bufferTextoHoras = horasATexto(Math.abs(bufferSemanal));
                                const bufferLabel = esPositivo ? 'extras' : 'faltantes';

                                bufferEl.innerHTML = `<span style="color: ${bufferColor}; font-weight: 500;">
                                ${bufferIcono} ${bufferTextoHoras} ${bufferLabel} esta semana
                                </span>`;
                            }
                        }
                    }

                    // 4. L√ìGICA ESPEC√çFICA DE VISTA
                    if (vistaActual === 'semana') {
                        tituloEl.innerHTML = `<svg class="icon"><use href="#icon-calendar-simple" /></svg> Esta Semana`;

                        const tot = registros.filter(r =>
                            r.fecha >= ini && r.fecha <= fn && !(r.entrada === '00:00' && r.salida === '00:00')
                        ).reduce((s, r) => s + r.total, 0);

                        const horasDescontar = D.calcularHorasFeriadoEnRango(ini, fn);
                        const objetivoAjustado = Math.max(0, horasSemanales - horasDescontar);
                        const prog = objetivoAjustado > 0 ? Math.min((tot / objetivoAjustado) * 100, 100) : 100;

                        if (statsEl) statsEl.innerHTML = `<div>${horasATexto(tot)}</div>`;
                        if (progressEl) {
                            progressEl.style.width = prog + '%';
                            setProgressBarColor(progressEl, tot >= objetivoAjustado ? 'green' : 'blue');
                        }

                        if (mensajeEl) {
                            // --- L√ìGICA CORREGIDA: USO DE CONFIGURACI√ìN DE D√çAS H√ÅBILES ---
                            const diaSemanaHoy = new Date().getDay(); // 0=Dom, 1=Lun...
                            let esDiaDeDescanso = false;

                            if (diaSemanaHoy === 0) {
                                // Domingo es descanso salvo que trabajes 7 d√≠as
                                esDiaDeDescanso = (diasHabilesConfig < 7);
                            } else {
                                // Lunes a S√°bado: es descanso si el d√≠a actual supera tu configuraci√≥n
                                // Ej: Si config es 5 (Lun-Vie), S√°bado (6) > 5 -> Descanso (True)
                                // Ej: Si config es 6 (Lun-Sab), S√°bado (6) no es > 6 -> Laboral (False)
                                esDiaDeDescanso = (diaSemanaHoy > diasHabilesConfig);
                            }

                            if (objetivoAjustado === 0) {
                                mensajeEl.textContent = `Semana sin objetivo. Total: ${horasATexto(tot)}`;
                            } else if (esDiaDeDescanso) {
                                // Mensaje de resumen (fin de jornada laboral semanal)
                                mensajeEl.textContent = tot >= objetivoAjustado ?
                                    `Terminaste con ${horasATexto(tot - objetivoAjustado)} dem√°s` :
                                    `Faltaron ${horasATexto(objetivoAjustado - tot)}`;
                            } else {
                                // Mensaje activo (a√∫n en jornada laboral)
                                mensajeEl.textContent = tot >= objetivoAjustado ?
                                    `¬°Bien! ${horasATexto(tot - objetivoAjustado)} extras` :
                                    `Faltan ${horasATexto(objetivoAjustado - tot)}`;
                            }
                        }
                        if (hintEl) hintEl.textContent = 'Toca para ver Hoy';

                    } else {
                        // VISTA DIARIA
                        tituloEl.innerHTML = `<svg class="icon"><use href="#icon-clock-simple" /></svg> Hoy`;
                        const regHoy = registros.find(r => r.fecha === hoy);
                        let tiempoTranscurrido = 0;
                        let objetivoDiario = horasDiarias;

                        if (regHoy && regHoy.entrada) {
                            const isFeriadoHoy = regHoy.entrada === '00:00' && regHoy.salida === '00:00';

                            if (isFeriadoHoy) {
                                if (statsEl) statsEl.innerHTML = `<div>ü•≥ Feriado</div>`;
                                if (progressEl) {
                                    progressEl.style.width = '100%';
                                    setProgressBarColor(progressEl, 'green');
                                }
                                if (mensajeEl) mensajeEl.textContent = `¬°D√≠a no laboral!`;
                            } else {
                                if (regHoy.salida) {
                                    tiempoTranscurrido = regHoy.total;
                                } else {
                                    const ahora = new Date();
                                    const horaActual = String(ahora.getHours()).padStart(2, '0') + ':' + String(ahora.getMinutes()).padStart(2, '0');
                                    const t = D.calcularHoras(regHoy.entrada, horaActual, regHoy.tiempoFuera || null);
                                    tiempoTranscurrido = t ? t.total : 0;
                                }

                                const prog = objetivoDiario > 0 ? Math.min((tiempoTranscurrido / objetivoDiario) * 100, 100) : 100;

                                if (statsEl) statsEl.innerHTML = `<div>${horasATexto(tiempoTranscurrido)}</div>`;
                                if (progressEl) progressEl.style.width = prog + '%';

                                if (regHoy.salida) {
                                    setProgressBarColor(progressEl, tiempoTranscurrido >= objetivoDiario ? 'green' : 'red');
                                    const dif = tiempoTranscurrido - objetivoDiario;
                                    if (mensajeEl) mensajeEl.textContent = dif >= 0 ? `${horasATexto(dif)} extras` : `Faltaron ${horasATexto(Math.abs(dif))}`;
                                } else {
                                    setProgressBarColor(progressEl, 'blue');
                                    const faltante = Math.max(0, objetivoDiario - tiempoTranscurrido);
                                    if (mensajeEl) mensajeEl.textContent = tiempoTranscurrido >= objetivoDiario ? `¬°Cumplido! (+${horasATexto(tiempoTranscurrido - objetivoDiario)})` : `Faltan ${horasATexto(faltante)}`;
                                }
                            }
                        } else {
                            if (progressEl) {
                                progressEl.style.width = '0%';
                                setProgressBarColor(progressEl, 'blue');
                            }
                            if (statsEl) statsEl.innerHTML = `<div style="font-size: 1.8rem;">üò¥ Sin actividad</div>`;
                            if (mensajeEl) mensajeEl.textContent = '...';
                        }
                        if (hintEl) hintEl.textContent = 'Toc√° para ver la Semana';
                    }
                }

                function alternarTema() {
                    let temaOscuro = !D.cargarConfiguracion().temaOscuro;
                    document.body.classList.toggle('dark-mode');
                    try { localStorage.setItem('temaOscuro', temaOscuro); } catch (e) { }

                    const toggleBtn = $('theme-toggle').querySelector('use');
                    if (temaOscuro) {
                        toggleBtn.setAttribute('href', '#icon-sun');
                    } else {
                        toggleBtn.setAttribute('href', '#icon-moon');
                    }
                }

                function alternarVista() {
                    let vistaActual = D.vistaActual() === 'semana' ? 'diaria' : 'semana';
                    D.setVistaActual(vistaActual);
                    try {
                        localStorage.setItem('vistaActual', vistaActual);
                    } catch (e) { }
                    actualizarUI();
                }

                function pegarHoraActual(id) {
                    const now = new Date();
                    const h = String(now.getHours()).padStart(2, '0');
                    const m = String(now.getMinutes()).padStart(2, '0');
                    const c = $(id);
                    if (c) c.value = `${h}:${m}`;
                }

                function limpiarCampo(id) {
                    const c = document.getElementById(id);
                    if (c) c.value = '';
                }

                function formatearInput(e) {
                    let v = e.target.value.replace(/[^0-9]/g, '');
                    if (v.length >= 3) v = v.slice(0, 2) + ':' + v.slice(2, 4);
                    e.target.value = v;
                }

                function actualizarFeedbackConfig() {
                    const dias = parseFloat($('config-dias-habiles').value) || 5;
                    const horas = parseFloat($('config-horas-diarias').value) || 7;
                    const total = dias * horas;
                    $('config-total-feedback').textContent = `(Total semanal: ${total}hs)`;
                }

                function incrementarHorasDiarias() {
                    let valorActual = parseFloat($('config-horas-diarias').value);
                    if (isNaN(valorActual)) valorActual = D.horasDiarias();
                    let nuevoValor = valorActual + 0.5;
                    if (nuevoValor > 24) nuevoValor = 24;
                    $('config-horas-diarias').value = nuevoValor;
                    actualizarFeedbackConfig();
                }

                function decrementarHorasDiarias() {
                    let valorActual = parseFloat($('config-horas-diarias').value);
                    if (isNaN(valorActual)) valorActual = D.horasDiarias();
                    let nuevoValor = valorActual - 0.5;
                    if (nuevoValor < 1) nuevoValor = 1;
                    $('config-horas-diarias').value = nuevoValor;
                    actualizarFeedbackConfig();
                }

                function incrementarDiasHabiles() {
                    let valorActual = parseFloat($('config-dias-habiles').value);
                    if (isNaN(valorActual)) valorActual = D.diasHabiles();
                    let nuevoValor = valorActual + 1;
                    if (nuevoValor > 7) nuevoValor = 7;
                    $('config-dias-habiles').value = nuevoValor;
                    actualizarFeedbackConfig();
                }

                function decrementarDiasHabiles() {
                    let valorActual = parseFloat($('config-dias-habiles').value);
                    if (isNaN(valorActual)) valorActual = D.diasHabiles();
                    let nuevoValor = valorActual - 1;
                    if (nuevoValor < 1) nuevoValor = 1;
                    $('config-dias-habiles').value = nuevoValor;
                    actualizarFeedbackConfig();
                }

                function mostrarConfig() {
                    $('config-dias-habiles').value = D.diasHabiles();
                    $('config-horas-diarias').value = D.horasDiarias();
                    actualizarFeedbackConfig();
                    $('modal-config').classList.add('show');
                }

                function cerrarConfig() {
                    $('modal-config').classList.remove('show');
                }

                function cerrarEdicion() {
                    $('modal-editar').classList.remove('show');
                    D.setEditandoId(null);
                }

                function mostrarImportar() {
                    $('file-import').value = '';
                    $('modal-importar').classList.add('show');
                }

                function cerrarImportar() {
                    $('modal-importar').classList.remove('show');
                }

                function init() {
                    if (typeof (Storage) === "undefined") {
                        alert("Tu navegador no soporta localStorage.");
                        return;
                    }

                    const config = D.cargarConfiguracion();
                    const temaOscuro = config.temaOscuro;
                    D.setVistaActual(config.vistaActual);

                    D.setDiasHabiles(config.diasHabiles);
                    D.setHorasDiarias(config.horasDiarias);

                    D.registros().splice(0, D.registros().length, ...D.cargarConVerificacion());
                    HistoryManager.saveState(D.registros());
                    HistoryManager.updateButtons();

                    if (localStorage.getItem('horasDiarias') === null) {
                        localStorage.setItem('horasDiarias', config.horasDiarias);
                    }
                    if (localStorage.getItem('diasHabiles') === null) {
                        localStorage.setItem('diasHabiles', config.diasHabiles);
                    }

                    const toggleBtn = $('theme-toggle').querySelector('use');
                    if (temaOscuro) {
                        document.body.classList.add('dark-mode');
                        toggleBtn.setAttribute('href', '#icon-sun');
                    } else {
                        toggleBtn.setAttribute('href', '#icon-moon');
                    }

                    $('fecha').value = obtenerFechaHoy();
                    ['entrada', 'salida', 'edit-entrada', 'edit-salida', 'edit-tiempo-fuera'].forEach(id => {
                        const el = $(id);
                        if (el) el.addEventListener('input', formatearInput);
                    });

                    window.UILogic = {
                        alternarTema, mostrarConfig, cerrarConfig, pegarHoraActual, alternarVista,
                        cerrarEdicion, mostrarImportar, cerrarImportar, actualizarUI, mostrarToast,
                        mostrarError, limpiarError, resetearBoton, restaurarBotonGuardarEdicion,
                        incrementarHorasDiarias, decrementarHorasDiarias, limpiarCampo,
                        incrementarDiasHabiles, decrementarDiasHabiles, obtenerFechaHoy
                    };
                    window.DataManagement = {
                        agregarRegistro: D.agregarRegistro, guardarConfig: D.guardarConfig, exportarJSON: D.exportarJSON,
                        mostrarImportar: mostrarImportar, importarDatos: D.importarDatos, borrarTodoHistorial: D.borrarTodoHistorial,
                        guardarEdicion: D.guardarEdicion, eliminarRegistroActual: D.eliminarRegistroActual, cargarMasRegistros: D.cargarMasRegistros,
                        undoAction: D.undoAction, redoAction: D.redoAction
                    };
                    window.HistoryManager = {
                        undo: D.undoAction,
                        redo: D.redoAction
                    };

                    actualizarUI();
                    setInterval(actualizarUI, 60000);
                    console.log('Sistema iniciado correctamente Luigibosca');
                }

                return {
                    init, obtenerFechaHoy, pegarHoraActual, alternarTema, alternarVista, mostrarConfig, cerrarConfig,
                    cerrarEdicion, mostrarImportar, cerrarImportar, actualizarUI, mostrarToast, mostrarError,
                    limpiarError, resetearBoton, restaurarBotonGuardarEdicion,
                    incrementarHorasDiarias, decrementarHorasDiarias, limpiarCampo,
                    incrementarDiasHabiles, decrementarDiasHabiles
                };

            })(SecurityAndUtils, DataManagement);

            UILogic.init();
        })();
    </script>
    <script>
        // Registro del Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (registration) {
                        console.log('ServiceWorker registrado con √©xito: ', registration.scope);
                    }, function (err) {
                        console.log('ServiceWorker fall√≥: ', err);
                    });
            });
        }
    </script>
</body>

</html>
